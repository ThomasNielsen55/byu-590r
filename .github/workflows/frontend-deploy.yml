name: Frontend Deploy

on:
  push:
    branches: [main]
    paths: ["web-app/**"]
  pull_request:
    branches: [main]
    paths: ["web-app/**"]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: |
          # Try npm ci first, fall back to npm install if lock file is out of sync
          set +e
          OUTPUT=$(npm ci 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "npm ci succeeded"
          elif echo "$OUTPUT" | grep -q "package.json and package-lock.json.*are in sync\|Missing:.*from lock file"; then
            echo "Lock file out of sync, running npm install..."
            npm install
          else
            echo "npm ci failed: $OUTPUT"
            exit $EXIT_CODE
          fi
        working-directory: ./web-app

      - name: Run linting
        run: npm run lint || echo "Linting not configured or failed, continuing..."
        working-directory: ./web-app
        continue-on-error: true

      - name: Run tests
        run: npm run test -- --watch=false --browsers=ChromeHeadless
        working-directory: ./web-app

      - name: Build application
        run: npm run build
        working-directory: ./web-app

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web-app/dist/
          retention-days: 1

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: |
          # Try npm ci first, fall back to npm install if lock file is out of sync
          set +e
          OUTPUT=$(npm ci 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "npm ci succeeded"
          elif echo "$OUTPUT" | grep -q "package.json and package-lock.json.*are in sync\|Missing:.*from lock file"; then
            echo "Lock file out of sync, running npm install..."
            npm install
          else
            echo "npm ci failed: $OUTPUT"
            exit $EXIT_CODE
          fi
        working-directory: ./web-app

      - name: Build for production
        run: npm run build
        working-directory: ./web-app

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Create deployment directory
          ssh ubuntu@${{ secrets.EC2_HOST }} "mkdir -p /tmp/deploy-frontend"

          # Copy built files to EC2
          rsync -avz --delete \
            ./web-app/dist/ ubuntu@${{ secrets.EC2_HOST }}:/tmp/deploy-frontend/

          # Deploy on server
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          # Stop nginx temporarily
          sudo systemctl stop nginx

          # Backup current frontend
          sudo mv /var/www/byu-590r/frontend/dist /var/www/byu-590r/frontend/dist.backup.$(date +%Y%m%d_%H%M%S) || true

          # Deploy new frontend
          sudo mkdir -p /var/www/byu-590r/frontend
          sudo mv /tmp/deploy-frontend /var/www/byu-590r/frontend/dist
          sudo chown -R ubuntu:www-data /var/www/byu-590r/frontend/dist
          sudo chmod -R 755 /var/www/byu-590r/frontend/dist

          # Restart nginx
          sudo systemctl start nginx
          sudo systemctl status nginx

          # Clean up old backups (keep only last 5)
          sudo ls -t /var/www/byu-590r/frontend/dist.backup.* 2>/dev/null | tail -n +6 | xargs sudo rm -rf || true
          EOF

          echo "Frontend deployment completed successfully!"
