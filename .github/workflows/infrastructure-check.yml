name: Infrastructure Check and Setup

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      infrastructure-exists: ${{ steps.check.outputs.exists }}
      instance-id: ${{ steps.check.outputs.instance-id }}
      instance-ip: ${{ steps.check.outputs.instance-ip }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Check if infrastructure exists
        id: check
        run: |
          echo "Checking for existing BYU 590R infrastructure..."

          # Check for existing EC2 instances with our project tag
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=byu-590r-server" \
                     "Name=instance-state-name,Values=running,pending,stopping,stopped" \
            --query 'Reservations[*].Instances[*].[InstanceId,PublicIpAddress,State.Name]' \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "No existing infrastructure found"
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "Found existing infrastructure:"
            echo "$INSTANCES"
            
            # Get the first running instance
            INSTANCE_ID=$(echo "$INSTANCES" | head -n1 | awk '{print $1}')
            INSTANCE_IP=$(echo "$INSTANCES" | head -n1 | awk '{print $2}')
            STATE=$(echo "$INSTANCES" | head -n1 | awk '{print $3}')
            
            echo "Using instance: $INSTANCE_ID ($INSTANCE_IP) - State: $STATE"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "instance-id=$INSTANCE_ID" >> $GITHUB_OUTPUT
            echo "instance-ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          fi

  setup-infrastructure:
    needs: check-infrastructure
    runs-on: ubuntu-latest
    if: needs.check-infrastructure.outputs.infrastructure-exists == 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Setup EC2 infrastructure
        run: |
          echo "Setting up new EC2 infrastructure..."

          # Configuration
          KEY_NAME="byu-590r"
          SECURITY_GROUP="sg-016e86262e63e073b"
          PROJECT_NAME="byu-590r"

          # Create EC2 instance with enhanced tagging
          INSTANCE_ID=$(aws ec2 run-instances \
          --image-id ami-04f34746e5e1ec0fe \
          --instance-type t2.micro \
          --key-name "$KEY_NAME" \
          --security-group-ids "$SECURITY_GROUP" \
          --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$PROJECT_NAME-server},{Key=CreatedBy,Value=github-actions},{Key=Environment,Value=production},{Key=Project,Value=byu-590r},{Key=CreatedAt,Value=$(date -u +%Y-%m-%dT%H:%M:%S)},{Key=WorkflowRun,Value=${{ github.run_id }}}]" \
          --query 'Instances[0].InstanceId' \
          --output text)

          echo "Created instance: $INSTANCE_ID"
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

          # Wait for instance to be running
          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"

          # Get instance IP
          INSTANCE_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)

          echo "Instance IP: $INSTANCE_IP"
          echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.JOHN_PERSONAL_LAPTOP_SSH }}

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ env.INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Setup server dependencies
        run: |
          echo "Setting up server dependencies..."

          # Create setup script
          cat > setup-server.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Updating system packages..."
          sudo apt update && sudo apt upgrade -y

          echo "Installing Node.js 18..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

          echo "Installing PHP 8.3 and extensions..."
          sudo apt install -y software-properties-common
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt update
          sudo apt install -y php8.3 php8.3-fpm php8.3-mysql php8.3-xml php8.3-mbstring php8.3-curl php8.3-zip php8.3-gd php8.3-cli php8.3-common

          echo "Installing Composer..."
          curl -sS https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer
          sudo chmod +x /usr/local/bin/composer

          echo "Installing MySQL..."
          sudo apt install -y mysql-server
          sudo systemctl enable mysql
          sudo systemctl start mysql

          echo "Installing Nginx..."
          sudo apt install -y nginx
          sudo systemctl enable nginx
          sudo systemctl start nginx

          echo "Installing Git..."
          sudo apt install -y git

          echo "Creating application directories..."
          sudo mkdir -p /var/www/byu-590r/backend
          sudo mkdir -p /var/www/byu-590r/frontend
          sudo chown -R ubuntu:ubuntu /var/www/byu-590r

          echo "Setting up MySQL database..."
          sudo mysql -u root << 'MYSQL_EOF'
          CREATE DATABASE IF NOT EXISTS byu_590r_app;
          CREATE USER IF NOT EXISTS 'byu_user'@'localhost' IDENTIFIED BY 'byu590r123!';
          GRANT ALL PRIVILEGES ON byu_590r_app.* TO 'byu_user'@'localhost';
          FLUSH PRIVILEGES;
          MYSQL_EOF

          echo "Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/byu-590r > /dev/null << 'NGINX_EOF'
          server {
              listen 80;
              server_name _;
              
              root /var/www/byu-590r/frontend/dist/byu-590r-builder;
              index index.html;
              
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              location /api {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINX_EOF

          sudo ln -sf /etc/nginx/sites-available/byu-590r /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl reload nginx

          echo "Creating Laravel systemd service..."
          sudo tee /etc/systemd/system/byu-590r-laravel.service > /dev/null << 'SERVICE_EOF'
          [Unit]
          Description=BYU 590R Laravel Application
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/var/www/byu-590r/backend
          ExecStart=/usr/bin/php artisan serve --host=0.0.0.0 --port=8000
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          SERVICE_EOF

          sudo systemctl daemon-reload
          sudo systemctl enable byu-590r-laravel

          echo "Server setup complete!"
          EOF

          # Copy and run setup script
          scp -o StrictHostKeyChecking=no setup-server.sh ubuntu@${{ env.INSTANCE_IP }}:~/
          ssh ubuntu@${{ env.INSTANCE_IP }} "chmod +x setup-server.sh && ./setup-server.sh"

          # Clean up
          rm setup-server.sh

          echo "Infrastructure setup complete!"
          echo "Instance ID: ${{ env.INSTANCE_ID }}"
          echo "Instance IP: ${{ env.INSTANCE_IP }}"
