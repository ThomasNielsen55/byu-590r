name: BYU 590R Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Determine deployment configuration (shared logic)
  determine-config:
    name: Determine Deployment Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      ec2_host: ${{ steps.config.outputs.ec2_host }}
      ssh_key: ${{ steps.config.outputs.ssh_key }}
      branch_name: ${{ steps.config.outputs.branch_name }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}

    steps:
      - name: Determine deployment configuration
        id: config
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          EC2_HOST_BRANCH: ${{ secrets[format('EC2_HOST_{0}', github.ref_name)] }}
          EC2_SSH_KEY_BRANCH: ${{ secrets[format('EC2_SSH_PRIVATE_KEY_{0}', github.ref_name)] }}
        run: |
          # Main branch uses repo owner's default secrets
          # Other branches use branch-specific secrets configured by the branch owner
          SHOULD_DEPLOY="false"
          EC2_HOST=""
          SSH_KEY=""

          if [ "$BRANCH_NAME" = "main" ]; then
            EC2_HOST="${{ secrets.EC2_HOST }}"
            SSH_KEY="${{ secrets.EC2_SSH_PRIVATE_KEY }}"
            
            if [ -n "$EC2_HOST" ] && [ -n "$SSH_KEY" ]; then
              echo "Using production credentials for main branch (repo owner's secrets)"
              SHOULD_DEPLOY="true"
            else
              echo "Warning: Default secrets (EC2_HOST or EC2_SSH_PRIVATE_KEY) not found for main branch"
              echo "Skipping deployment. Please configure GitHub secrets:"
              echo "  - EC2_HOST"
              echo "  - EC2_SSH_PRIVATE_KEY"
            fi
          else
            # For other branches, use branch-specific secrets
            if [ -n "$EC2_HOST_BRANCH" ] && [ -n "$EC2_SSH_KEY_BRANCH" ]; then
              EC2_HOST="$EC2_HOST_BRANCH"
              SSH_KEY="$EC2_SSH_KEY_BRANCH"
              echo "Using branch-specific configuration for: $BRANCH_NAME"
              SHOULD_DEPLOY="true"
            else
              echo "Warning: Branch-specific secrets not found for branch: $BRANCH_NAME"
              echo "Skipping deployment. To enable deployment, configure:"
              echo "  - EC2_HOST_${BRANCH_NAME}"
              echo "  - EC2_SSH_PRIVATE_KEY_${BRANCH_NAME}"
            fi
          fi

          # Always set outputs, even if deployment should be skipped
          echo "ec2_host=$EC2_HOST" >> $GITHUB_OUTPUT
          echo "ssh_key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_KEY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Deployment Configuration Summary ==="
          echo "Branch: $BRANCH_NAME"
          echo "EC2_HOST: ${EC2_HOST:-NOT SET}"
          echo "SSH_KEY: ${SSH_KEY:+SET}${SSH_KEY:-NOT SET}"
          echo "Should Deploy: $SHOULD_DEPLOY"
          echo "========================================"

  # Run tests
  test-frontend:
    uses: ./.github/workflows/test-frontend.yml

  test-backend:
    uses: ./.github/workflows/test-backend.yml

  # Deploy Backend to EC2
  deploy-backend:
    needs: [test-frontend, test-backend, determine-config]
    uses: ./.github/workflows/deploy-backend.yml
    if: |
      github.event_name == 'push' &&
      needs.determine-config.result == 'success' &&
      needs.determine-config.outputs.should_deploy == 'true' &&
      needs.test-frontend.result == 'success' &&
      needs.test-backend.result == 'success'
    with:
      ec2_host: ${{ needs.determine-config.outputs.ec2_host }}
      ssh_key: ${{ needs.determine-config.outputs.ssh_key }}
    secrets: inherit

  # Deploy Frontend to EC2
  deploy-frontend:
    needs: [deploy-backend, determine-config]
    uses: ./.github/workflows/deploy-frontend.yml
    if: |
      github.event_name == 'push' &&
      needs.determine-config.result == 'success' &&
      needs.determine-config.outputs.should_deploy == 'true' &&
      needs.deploy-backend.result == 'success'
    with:
      ec2_host: ${{ needs.determine-config.outputs.ec2_host }}
    secrets: inherit

  # Run migrations
  run-migrations:
    needs: [deploy-frontend, determine-config]
    uses: ./.github/workflows/run-migrations.yml
    if: |
      github.event_name == 'push' &&
      needs.determine-config.result == 'success' &&
      needs.determine-config.outputs.should_deploy == 'true' &&
      needs.deploy-frontend.result == 'success'
    with:
      ec2_host: ${{ needs.determine-config.outputs.ec2_host }}
      ssh_key: ${{ needs.determine-config.outputs.ssh_key }}
    secrets: inherit

  # Complete deployment
  deploy-complete:
    needs: [run-migrations, determine-config]
    uses: ./.github/workflows/deploy-complete.yml
    if: |
      github.event_name == 'push' &&
      needs.determine-config.result == 'success' &&
      needs.determine-config.outputs.should_deploy == 'true' &&
      needs.run-migrations.result == 'success'
    with:
      ec2_host: ${{ needs.determine-config.outputs.ec2_host }}
      branch_name: ${{ needs.determine-config.outputs.branch_name }}
    secrets: inherit
