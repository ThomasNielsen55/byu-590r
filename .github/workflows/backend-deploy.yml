name: Backend Deploy

on:
  push:
    branches: [main]
    paths: ["backend/**"]
  pull_request:
    branches: [main]
    paths: ["backend/**"]
  workflow_call:
    inputs:
      instance-ip:
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, dom, fileinfo, mysql
          coverage: none

      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
        working-directory: ./backend

      - name: Install Dependencies
        run: |
          # Try install first, fall back to update if lock file is incompatible
          set +e
          OUTPUT=$(composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Composer install succeeded"
          elif echo "$OUTPUT" | grep -q "does not contain a compatible set of packages"; then
            echo "Lock file incompatible, running composer update..."
            composer update -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          else
            echo "Composer install failed: $OUTPUT"
            exit $EXIT_CODE
          fi
        working-directory: ./backend

      - name: Generate key
        run: php artisan key:generate
        working-directory: ./backend

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
        working-directory: ./backend

      - name: Create Database
        run: |
          mkdir -p /tmp/backend
          touch /tmp/backend/database.sqlite
        working-directory: ./backend

      - name: Execute tests (Unit and Feature tests) via PHPUnit
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: /tmp/backend/database.sqlite
        run: php artisan test
        working-directory: ./backend

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Create deployment directory
          ssh ubuntu@${{ secrets.EC2_HOST }} "mkdir -p /tmp/deploy-backend"

          # Copy files to EC2
          rsync -avz --delete \
            --exclude 'vendor/' \
            --exclude 'node_modules/' \
            --exclude '.git/' \
            --exclude 'storage/logs/*' \
            --exclude 'storage/framework/cache/*' \
            --exclude 'storage/framework/sessions/*' \
            --exclude 'storage/framework/views/*' \
            --exclude 'tests/' \
            --exclude '.env' \
            ./backend/ ubuntu@${{ secrets.EC2_HOST }}:/tmp/deploy-backend/

          # Deploy on server
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          cd /tmp/deploy-backend

          # Install dependencies (try install, fall back to update if incompatible)
          set +e
          OUTPUT=$(composer install --no-dev --optimize-autoloader 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Composer install succeeded"
          elif echo "$OUTPUT" | grep -q "does not contain a compatible set of packages"; then
            echo "Lock file incompatible, running composer update..."
            composer update --no-dev --optimize-autoloader
          else
            echo "Composer install failed: $OUTPUT"
            exit $EXIT_CODE
          fi

          # Create .env if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

          # Update .env with production values
          sed -i 's/APP_ENV=local/APP_ENV=production/' .env
          sed -i 's/APP_DEBUG=true/APP_DEBUG=false/' .env
          sed -i 's/DB_CONNECTION=sqlite/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=byu_590r_app/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=byu_user/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=byu590r123!/' .env

          # Generate app key if not set
          if ! grep -q "APP_KEY=" .env || grep -q "APP_KEY=$" .env; then
            php artisan key:generate
          fi

          # Run migrations
          php artisan migrate --force

          # Set permissions
          sudo chown -R ubuntu:www-data storage bootstrap/cache
          sudo chmod -R 775 storage bootstrap/cache

          # Stop existing service
          sudo systemctl stop byu-590r-laravel || true

          # Replace application files
          sudo rm -rf /var/www/byu-590r/backend
          sudo mv /tmp/deploy-backend /var/www/byu-590r/backend
          sudo chown -R ubuntu:ubuntu /var/www/byu-590r/backend

          # Start service
          sudo systemctl start byu-590r-laravel
          sudo systemctl status byu-590r-laravel
          EOF

          echo "Backend deployment completed successfully!"
