name: Test Backend

on:
  workflow_call:

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ${{ secrets.DB_DATABASE || 'byu_590r_app' }}_test
          MYSQL_USER: ${{ secrets.DB_USERNAME || 'byu_user' }}
          MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD || 'byu_password' }}
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, dom, fileinfo, mysql
          coverage: none

      - name: Install Composer dependencies
        run: |
          cd backend
          # Try install first, fall back to update if lock file is incompatible
          set +e
          OUTPUT=$(composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "Composer install succeeded"
          elif echo "$OUTPUT" | grep -q "does not contain a compatible set of packages"; then
            echo "Lock file incompatible, running composer update..."
            composer update -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          else
            echo "Composer install failed: $OUTPUT"
            exit $EXIT_CODE
          fi

      - name: Setup Laravel environment
        run: |
          cd backend
          cp .env.example .env
          php artisan key:generate
          sed -i 's/DB_HOST=mysql/DB_HOST=127.0.0.1/' .env

          # Use secrets for database configuration
          if [ -n "${{ secrets.DB_DATABASE }}" ]; then
            sed -i "s/DB_DATABASE=byu_590r_app/DB_DATABASE=${{ secrets.DB_DATABASE }}_test/" .env
          else
            sed -i 's/DB_DATABASE=byu_590r_app/DB_DATABASE=byu_590r_app_test/' .env
          fi

          if [ -n "${{ secrets.DB_USERNAME }}" ]; then
            sed -i "s/DB_USERNAME=byu_user/DB_USERNAME=${{ secrets.DB_USERNAME }}/" .env
          fi

          if [ -n "${{ secrets.DB_PASSWORD }}" ]; then
            sed -i "s/DB_PASSWORD=byu_password/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/" .env
          fi

          # Use APP_DEBUG from secrets if provided
          if [ -n "${{ secrets.APP_DEBUG }}" ]; then
            sed -i "s/APP_DEBUG=.*/APP_DEBUG=${{ secrets.APP_DEBUG }}/" .env
          else
            echo "APP_DEBUG=true" >> .env
          fi

          # Add OPENAI_API_KEY from secrets if provided
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            sed -i "s/OPENAI_API_KEY=.*/OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}/" .env
          fi

          # Add S3_BUCKET from secrets if provided
          if [ -n "${{ secrets.S3_BUCKET }}" ]; then
            sed -i "s/S3_BUCKET=.*/S3_BUCKET=${{ secrets.S3_BUCKET }}/" .env
          else
            echo "S3_BUCKET=byu-590r-$(date +%s)-test" >> .env
          fi

          # Add AWS credentials for S3 testing
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
          fi
          if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
          fi
          if [ -n "${{ secrets.AWS_REGION }}" ]; then
            echo "AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}" >> .env
          else
            echo "AWS_DEFAULT_REGION=us-west-1" >> .env
          fi

      - name: Run Laravel tests
        run: |
          cd backend
          php artisan test

      - name: Generate Laravel application key
        run: |
          cd backend
          php artisan key:generate

