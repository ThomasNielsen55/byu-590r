name: Cleanup Failed Infrastructure

on:
  workflow_run:
    workflows: ["Infrastructure Check and Setup"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      cleanup_all:
        description: "Clean up all byu-590r instances (not just failed ones)"
        required: false
        default: "false"
        type: boolean

jobs:
  cleanup-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.inputs.cleanup_all == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: List existing instances
        run: |
          echo "Current BYU 590R instances:"
          aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=byu-590r-server" \
            --query 'Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress,Tags[?Key==`CreatedAt`].Value|[0]]' \
            --output table

      - name: Clean up failed infrastructure
        run: |
          echo "Cleaning up infrastructure..."

          if [ "${{ github.event.inputs.cleanup_all }}" = "true" ]; then
            echo "Cleaning up ALL byu-590r instances..."
            INSTANCES_TO_TERMINATE=$(aws ec2 describe-instances \
              --filters "Name=tag:Name,Values=byu-590r-server" \
                       "Name=instance-state-name,Values=running,pending,stopping,stopped" \
              --query 'Reservations[*].Instances[*].InstanceId' \
              --output text)
          else
            echo "Cleaning up instances from failed deployment..."
            # Find instances created in the last 2 hours (likely from failed deployment)
            INSTANCES_TO_TERMINATE=$(aws ec2 describe-instances \
              --filters "Name=tag:Name,Values=byu-590r-server" \
                       "Name=instance-state-name,Values=running,pending" \
              --query 'Reservations[*].Instances[?LaunchTime>=`'$(date -d '2 hours ago' -u +%Y-%m-%dT%H:%M:%S)'`].[InstanceId]' \
              --output text)
          fi

          if [ -n "$INSTANCES_TO_TERMINATE" ]; then
            echo "Terminating instances: $INSTANCES_TO_TERMINATE"
            aws ec2 terminate-instances --instance-ids $INSTANCES_TO_TERMINATE
            
            echo "Waiting for instances to terminate..."
            aws ec2 wait instance-terminated --instance-ids $INSTANCES_TO_TERMINATE
            
            echo "Cleanup completed successfully!"
          else
            echo "No instances found to clean up"
          fi

      - name: Verify cleanup
        run: |
          echo "Verifying cleanup..."
          REMAINING_INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=byu-590r-server" \
                     "Name=instance-state-name,Values=running,pending,stopping" \
            --query 'Reservations[*].Instances[*].[InstanceId,State.Name]' \
            --output text)

          if [ -n "$REMAINING_INSTANCES" ]; then
            echo "Warning: Some instances are still running:"
            echo "$REMAINING_INSTANCES"
          else
            echo "âœ… All instances successfully terminated"
          fi
